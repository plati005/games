<!-- Create the canvas -->
<canvas id="ctx" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<br>
<span>V1 Highscore: <span>
<span id="highscore"></span>



<script src="js/Entities.js"></script> 
<script>

//create canvas variable named ctx
var ctx = document.getElementById("ctx").getContext("2d");
ctx.font = '30px Arial';
var HEIGHT = 1000;
var WIDTH = 1000;
var timeWhenGameStarted = Date.now();   //return time in ms
var frameCount = 0;
var score = 0;
var highscore = 0;
var paused = false;

var img = new Image();
img.source = "img/player.png";

//load images in memory
var Img = {};
Img.player = new Image();
Img.player.src = "img/player.png";
Img.enemy = new Image();
Img.enemy.src = "img/enemy.png";
Img.bullet = new Image();
Img.bullet.src = "img/bullet.png";
Img.upgrade1 = new Image();
Img.upgrade1.src = "img/bullet.png";
Img.upgrade2 = new Image();
Img.upgrade2.src = "img/bullet.png";

testCollisionRectRect = function(rect1,rect2){
        return rect1.x <= rect2.x+rect2.width
                && rect2.x <= rect1.x+rect1.width
                && rect1.y <= rect2.y + rect2.height
                && rect2.y <= rect1.y + rect1.height;
}
 
document.onclick = function(mouse){
        player.performAttack();
}

/*
document.ontouchstart = function(mouse){
        player.performAttack();
}
*/

document.oncontextmenu = function(mouse){
        player.performSpecialAttack();
        mouse.preventDefault();
}
 
document.onmousemove = function(mouse){
        var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
        var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;
       
        //mouseX -= player.x;
        //mouseY -= player.y;
		mouseX -= WIDTH/2;
        mouseY -= HEIGHT/2;        			
       
        player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180;
}
 
document.onkeydown = function(event){
        if(event.keyCode === 68)        //d
                player.pressingRight = true;
        else if(event.keyCode === 83)   //s
                player.pressingDown = true;
        else if(event.keyCode === 65) //a
                player.pressingLeft = true;
        else if(event.keyCode === 87) // w
                player.pressingUp = true;
		else if(event.keyCode === 80) //p
				paused = !paused;
}
 
document.onkeyup = function(event){
        if(event.keyCode === 68)        //d
                player.pressingRight = false;
        else if(event.keyCode === 83)   //s
                player.pressingDown = false;
        else if(event.keyCode === 65) //a
                player.pressingLeft = false;
        else if(event.keyCode === 87) // w
                player.pressingUp = false;
}


tilt = function(event) {
		if(event.gamma > 20)    			
                player.pressingRight = true;
		else player.pressingRight = false;
		if(event.gamma < -20)    			
                player.pressingLeft = true;
		else player.pressingLeft = false;
		
		if(event.beta < -20)    			
                player.pressingUp = true;
		else player.pressingUp = false;
		if(event.beta > 20)    			
                player.pressingDown = true;
		else player.pressingDown = false;
}

if (window.DeviceOrientationEvent) {
	window.addEventListener("deviceorientation", tilt);
} 

update = function(){
        
		if(paused){
			ctx.fillText('Paused', WIDTH/2, HEIGHT/2);
			return;
		}
		
		//refresh page
		ctx.clearRect(0,0,WIDTH,HEIGHT);
        currentMap.draw();
		
		//set counters
		frameCount++;
        score++;
		
		//generate Entities
        if(frameCount % 100 === 0)      //every 4 sec
                randomlyGenerateEnemy();
		/*/
        if(frameCount % 75 === 0)       //every 3 sec
                randomlyGenerateUpgrade();
        //*/
       
		//refresh bullets
        for(var key in bulletList){
                bulletList[key].update(); 
        }
		
		//refresh upgrades
        for(var key in upgradeList){
                upgradeList[key].update();

        }
		
		//refresh enemies
        for(var key in enemyList){
                enemyList[key].update();
        }
		
		//refresh player
        player.update();
		
		//add HP and score
        ctx.fillText(player.hp + " Hp",0,30);
        ctx.fillText('Score: ' + score,200,30);
}
 
startNewGame = function(){
        player.hp = 10;
        timeWhenGameStarted = Date.now();
        frameCount = 0;
        if (highscore < score ) {
			console.log("New high score!");
			highscore = score;
			document.getElementById("highscore").innerHTML = highscore;
		}
		score = 0;
        enemyList = {};
        upgradeList = {};
        bulletList = {};
        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
       
}

Maps = function(id, imgSrc, width, height, fluff) {
	var self = {
		id:id,
		image:new Image(),
		width:width,
		height:height,
		fluff:fluff  //TODO: make this flexible per map per screensize
	}
	self.image.src = imgSrc;
	
	self.draw = function (){
		var x = WIDTH/2-player.x;
		var y = HEIGHT/2-player.y;
		ctx.drawImage(self.image, 0, 0, self.image.width, self.image.height, x, y, self.image.width, self.image.height);
	}
	return self;
	
}	
currentMap = Maps('field',"img/map2.png", 2304, 1984, 512);


player = Player();
startNewGame(); 
 
setInterval(update,40);
 

 
 
 
 
 
 
 
 
 
 
 
</script>